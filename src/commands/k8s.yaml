description: >
  "Steps sequence for Kubernetes deployment"

parameters:
  service:
    type: string
    default: ""
    description: >
      Application service to deploy in Kubernetes.
  env:
    type: enum
    default: "development"
    enum: [ "development", "staging", "production" ]
    description: >
      Running environment.
  cluster_name:
    type: string
    default: ""
    description: >
      Name of the AKS cluster.
  resource_group:
    type: string
    default: ""
    description: >
      Azure resource group including the AKS cluster.
  version_file:
    type: string
    default: "VERSION"
    description: >
      Name of the file that handles the current service version number.
  repository:
    type: string
    default: ""
    description: "Repository hosting Helm configurations"
  github_email:
    type: string
    default: "$GITHUB_USER_EMAIL"
    description: >
      GitHub user email of service account used to deploy.
  github_user:
    type: string
    default: "$GITHUB_USER_NAME"
    description: >
      GitHub user name of service account used to deploy.

steps:
  - run:
      name: Clone Deployment repository
      command: git clone git@github.com:cospirit/<< parameters.repository >> deployment
  - run:
      name: Update version in service configuration
      working_directory: deployment/clusters/<< parameters.env >>
      command: |
        sed -i '0,/version:.*$/ s/version:.*$/version: \"'$(cat << parameters.version_file >>)'\"/' values.services.<< parameters.service >>.yaml
        head -n 3 values.services.<< parameters.service >>.yaml
  - helm/install-helm-client:
      version: v2.17.0
  - azure-aks/update-kubeconfig-with-credentials:
      cluster-name: << parameters.cluster_name >>
      install-kubectl: true
      perform-login: true
      resource-group: << parameters.resource_group >>
  - run:
      name: Deploy to << parameters.env >> cluster
      working_directory: deployment/clusters/<< parameters.env >>
      command: FORCE=1 make deploy.services.<< parameters.service >>
  - run:
      name: Commit and push service configuration file
      working_directory: deployment
      command: |
        git config --global user.email << parameters.github_email >>
        git config --global user.name << parameters.github_user >>
        git pull
        git commit \
          -m "k8s: update << parameters.service >> service version to $(cat << parameters.version_file >>) [skip ci]" \
          clusters/<< parameters.env >>/values.services.<< parameters.service >>.yaml
        git push
